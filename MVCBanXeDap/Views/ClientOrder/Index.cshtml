@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section CSSs {
    <!-- Datatable CSS-->
    <link rel="stylesheet" href="//cdn.datatables.net/2.1.8/css/dataTables.dataTables.min.css" />


    <style>
        /* //Căn chỉnh giao diện thành phần của Datatable */
        div.dt-info {
            margin-top: 0.5em;
            text-align: center;
        }

        div.dt-search {
            margin-top: 0.5em;
            float: left;
        }

        div.dt-length {
            margin-top: 0.5em;
            float: right;
        }

        div.dt-paging {
            clear: both;
            text-align: left;
            margin-top: 0.5em;
        }
    </style>
}

<div class="col-md-12">
    <div class="card">
        <div class="card-header d-flex justify-content-between">
            <h4 class="card-title">Danh sách hóa đơn</h4>
            <a id="exportInvoicesButton" class="" href="/clientorder/ExportAllInvoicesAsSinglePDF" title="Xuất tất cả hóa đơn."><i class="bi bi-download fa-2x"></i></a>
        </div>
        <div class="card-body">
            <!-- Bộ lọc: Bộ lọc hóa đơn -->
            <div class="mb-4">
                <h5 class="mb-3">Bộ lọc hóa đơn</h5>
                <div class="row g-3">
                    <!-- Ngày tạo -->
                    <div class="col-md-3">
                        <div class="mb-2">
                            <label for="ngayTao" class="form-label">Ngày tạo</label>
                        </div>
                        <div>
                            <input id="ngayTao" name="ngayTao" type="date" class="form-control" />
                        </div>
                    </div>

                    <!-- Thời gian giao -->
                    <div class="col-md-3">
                        <div class="mb-2">
                            <label for="thoiGianGiao" class="form-label">Thời gian giao</label>
                        </div>
                        <div>
                            <input id="thoiGianGiao" name="thoiGianGiao" type="date" class="form-control" />
                        </div>
                    </div>

                    <!-- Hình thức thanh toán -->
                    <div class="col-md-3">
                        <div class="mb-2">
                            <label for="httt" class="form-label">Thanh toán</label>
                        </div>
                        <div>
                            <select id="httt" name="httt" class="form-select">
                                <option value="" disabled selected hidden>Hình thức thanh toán</option>
                                <option value="VNPAY">VNPAY</option>
                                <option value="COD">COD</option>
                            </select>
                        </div>
                    </div>

                    <!-- Tình trạng -->
                    <div class="col-md-3">
                        <div class="mb-2">
                            <label for="tinhTrang" class="form-label">Tình trạng</label>
                        </div>
                        <div>
                            <select id="tinhTrang" name="tinhTrang" class="form-select">
                                <option value="" disabled selected hidden>Tình trạng</option>
                                <option value="Chờ xác nhận">Chờ xác nhận</option>
                                <option value="Đã xác nhận">Đã xác nhận</option>
                                <option value="Đã giao cho đơn vị vận chuyển">Đã giao cho đơn vị vận chuyển</option>
                                <option value="Đang giao hàng">Đang giao hàng</option>
                                <option value="Chờ thanh toán">Chờ thanh toán</option>
                                <option value="Đã thanh toán">Đã thanh toán</option>
                                <option value="Hoàn trả/Hoàn tiền">Hoàn trả/Hoàn tiền</option>
                                <option value="Đã hủy">Đã hủy</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Danh sách hóa đơn -->
            <div class="table-responsive">
                <table id="basic-datatables" class="display table table-striped table-hover">
                </table>
            </div>
        </div>


    </div>
</div>

<!-- Modal hiển thị thông tin chi tiết -->
<div id="coverContentDetailOrder" class="modal fade" tabindex="-1" aria-labelledby="invoiceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="invoiceModalLabel">Thông tin chi tiết hóa đơn</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Nội dung của hóa đơn sẽ được tải động thông qua AJAX -->
                <div>Loading...</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Datatable JS -->
    <script src="//cdn.datatables.net/2.1.8/js/dataTables.min.js"></script>

    <script>
        $(document).ready(function () {
            let datatable;
            loadDatatable();
        });
        $(document).ready(function() {
            // Cập nhật lại dữ liệu khi thay đổi bộ lọc
            $('#ngayTao, #httt, #tinhTrang, #thoiGianGiao').on('change', function () {
                datatable.ajax.reload();
            });
        });
        function loadDatatable() {
            // DataTable khởi tạo
            datatable = $('#basic-datatables').DataTable({
                ajax: {
                    url: '/ClientOrder/getall', // Đường dẫn API trả về danh sách hóa đơn
                    data: function (d) {
                        // Thêm các tham số lọc từ input của form
                        d.ngayTao = $('#ngayTao').val();
                        d.httt = $('#httt').val();
                        d.tinhTrang = $('#tinhTrang').val();
                        d.thoiGianGiao = $('#thoiGianGiao').val();
                    },
                    method: 'GET',
                    dataSrc: function(response) {
                        // Log phản hồi API để kiểm tra xem dữ liệu trả về đúng hay không
                        console.log("Response from API:", response);

                        if (response && response.data) {
                            // Trả dữ liệu về cho DataTable
                            return response.data;
                        } else {
                            console.error("API không trả về dữ liệu hợp lệ:", response);
                            return [];
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("Lỗi khi gọi API:", error);
                        console.log("Trạng thái:", xhr.status);
                            console.log("Phản hồi của lỗi:", xhr.responseText);
                            if (xhr.status === 401) {
                                toastr.warning("Phiên đã hết hạn. Vui lòng đăng nhập lại.");
                                // Redirect to the login page
                                window.location.href = '/Accounts/Login_Customer'; // Modify this URL to where your login page is located
                            } else {
                                toastr.error("Có lỗi xảy ra khi tải dữ liệu. Vui lòng thử lại!");
                            }
                    }
                },
                columns: [
                    { title: 'Mã', data: 'maHoaDon', className: 'text-center table-cell-ellipsis', width: '10%' },
                    { title: 'Ngày Tạo', data: 'ngayTao', className: 'text-center table-cell-ellipsis', width: '15%' },
                    { title: 'Hình Thức Thanh Toán', data: 'httt', className: 'text-center table-cell-ellipsis', width: '15%' },
                    {
                        title: 'Tình Trạng',
                        data: 'tinhTrang',
                        className: 'text-center table-cell-ellipsis',
                        width: '15%',
                        render: function (data, type, row) {
                            let options = [];
                            switch (data) {
                                case "Chờ xác nhận":
                                case "Đã xác nhận":
                                case "Đã giao cho đơn vị vận chuyển":
                                case "Đang giao hàng":
                                case "Đã giao cho khách":
                                case "Hoàn trả/Hoàn tiền":
                                case "Đã hủy":
                                    options.push(data);
                                    break;
                                case "Chờ thanh toán":
                                    options.push(data, "Hủy đơn");
                                    break;
                                case "Đã thanh toán":
                                    options.push(data, "Hoàn trả/Hoàn tiền");
                                    break;
                            }
                            return `
                                <select class="form-select">
                                    ${options.map(option =>
                                        `<option value="${option}" ${data === option ? 'selected' : ''}>${option}</option>`
                                    ).join('')}
                                </select>`;
                        }
                    },
                    { title: 'Họ Tên', data: 'hoten', className: 'text-center table-cell-ellipsis', width: '15%' },
                    { title: 'Số Điện Thoại', data: 'sdt', className: 'text-center table-cell-ellipsis', width: '10%' },
                    { title: 'Thời Gian Giao', data: 'thoiGianGiao', className: 'text-center table-cell-ellipsis', width: '15%' },
                    {
                        title: '',
                        data: 'maHoaDon',
                        className: 'text-center',
                        width: '5%',
                        render: function(data) {
                            return `
                                <span type="button"
                                        onclick="loadDetailOrderToModal('${data}')"
                                        data-bs-toggle="modal" data-bs-target="#coverContentDetailOrder">
                                    <i class="bi bi-info-circle"></i>
                                </span>`;
                        }
                    }
                ],
                paging: true,
                searching: true,
                language: {
                    sSearch: "Tìm kiếm:",
                    lengthMenu: "Hiển thị _MENU_ mục",
                    info: "Hiển thị _START_ đến _END_ trong tổng số _TOTAL_ mục",
                    paginate: {
                        first: "<<",
                        last: ">>",
                        next: ">",
                        previous: "<"
                    },
                    zeroRecords: `<div style="text-align: center;">Không tìm thấy kết quả nào.</div>`,
                    infoEmpty: "Không có mục nào để hiển thị",
                    infoFiltered: "(lọc từ _MAX_ mục)"
                },
                dom: '<"top"lf>rt<"bottom"p><"clear">' // Bố cục tìm kiếm và phân trang
            });
        }

        // Hàm tải chi tiết hóa đơn vào modal
        function loadDetailOrderToModal(idOrder) {
            $.ajax({
                url: "/ClientOrder/Detail", // API trả về chi tiết hóa đơn
                method: "GET",
                data: { idOrder: idOrder },
                success: function (response) {
                    $('#coverContentDetailOrder .modal-body').html(response); // Đổ nội dung chi tiết vào modal
                },
                error: function (xhr) {
                    $('#coverContentDetailOrder .modal-body').html(
                        `<div class="text-center text-danger">Không thể tải thông tin chi tiết hóa đơn. Vui lòng thử lại!</div>`
                    );
                }
            });
        }
    </script>
}
